<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>perf_counter: perf_counter (v1.9.5)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">perf_counter
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__r_e_a_d_m_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">perf_counter (v1.9.5) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >A dedicated performance counter for Cortex-M Systick. It shares the SysTick with users' original SysTick function(s) without interfering with it. This library will bring new functionalities, such as performance counter,<code>delay_us</code> and <code>clock()</code> service defined in <code>time.h</code>.</p>
<h2><a class="anchor" id="autotoc_md1"></a>
Features:</h2>
<ul>
<li><b>Measure CPU cycles for specified code segment</b></li>
<li><b>[NEW] Enhanced measurement services for RTOS</b><ul>
<li>Measures <b>RAW / True</b> cycles used for specified code segment inside a thread, <b>i.e. scheduling cost are removed</b>.</li>
<li>Measure <b>RAW/True</b> cycles used for a data-process-path across multiple threads.</li>
</ul>
</li>
<li><b>Easy to use</b><ul>
<li>Helper macros: <code><a class="el" href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__()</a></code> , <code><a class="el" href="perf__counter_8h.html#acfa3bf174dd68eeca5c7e4a16cdc24ea">__super_loop_monitor__()</a></code> etc.</li>
<li>Helper functions: <code><a class="el" href="perf__counter_8c.html#af33fd92801223d4befa49c610332ddd4" title="try to set a start pointer for the performance counter">start_cycle_counter()</a></code>, <code><a class="el" href="perf__counter_8c.html#a014af75d3945894c4740773e8a28d723" title="calculate the elapsed cycle count since the last start point">stop_cycle_counter()</a></code> etc.</li>
</ul>
</li>
<li><b>Support ALL Cortex-M processors</b><ul>
<li>Including <b>Cortex-M85</b> and Star-MC1</li>
</ul>
</li>
<li><b>Provide Free Services</b><ul>
<li>Do <b>NOT</b> interfering with existing SysTick based applications</li>
</ul>
</li>
<li><b>Support ALL arm compilers</b><ul>
<li>Arm Compiler 5 (armcc), Arm Compiler 6 (armclang)</li>
<li>arm gcc</li>
<li>LLVM</li>
<li>IAR</li>
</ul>
</li>
<li><b>Simplified Deployment</b><ul>
<li><b>Drag-and-Drop deployment for Arm Compiler 5 and Arm Compiler 6.</b></li>
<li><b>CMSIS-Pack is available</b></li>
</ul>
</li>
<li><b>Time based services</b><ul>
<li><code><a class="el" href="perf__counter_8c.html#a9776dfed871d0e0775c876f16e7618f7" title="delay specified time in microsecond">delay_us()</a></code> and <code><a class="el" href="perf__counter_8c.html#a2add8ab5b23b568bba6d46f9c977dbce" title="delay specified time in millisecond">delay_ms()</a></code></li>
<li>Provides Timestamp services via <em><b><a class="el" href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea" title="get the elapsed cycles since perf_counter is initialised">get_system_ticks()</a></b></em> and <code><a class="el" href="perf__counter_8c.html#a98c51d83fdb448a2733d0a309366149c" title="get the elapsed milliseconds since perf_counter is initialised">get_system_ms()</a></code></li>
</ul>
</li>
<li><b>Support both RTOS and bare-metal environments</b></li>
<li><b>Utilities for C language enhancement</b><ul>
<li>Macros to detect compilers, e.g. <code>__IS_COMPILER_ARM_COMPILER_6__</code>, <code>__IS_COMPILER_LLVM__</code> etc.</li>
<li>Macro to create atomicity for specified code block, i.e. <code>__IRQ_SAFE{...}</code></li>
<li>Helper macros for C language extension:<ul>
<li>VB like <code><a class="el" href="perf__counter_8h.html#afc5b077f9764ca6f11075ce72357dd65">with()</a></code></li>
<li><code><a class="el" href="perf__counter_8h.html#a623a729e6571efedb0c5528689d6120d">foreach()</a></code>, <a class="el" href="perf__counter_8h.html#a7b6c484887a402bba1af11b457264553">dimof()</a>, <code><a class="el" href="perf__counter_8h.html#a1409defa6d3e973b7efee74d2de7386d">CONNECT()</a></code></li>
<li>C# like <code><a class="el" href="perf__counter_8h.html#ad90955bd356a41041a7dcb112a450766">using()</a></code></li>
<li>simple overload feature of OOPC made out of ANSI-C99, <code><a class="el" href="perf__counter_8h.html#a9d1c7b8467fca7e2fcf0426ef294a171">__PLOOC_VA_NUM_ARGS()</a></code></li>
<li>...</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
1. How To Use</h1>
<h2><a class="anchor" id="autotoc_md3"></a>
1.1 Measure CPU cycles for specified code segment</h2>
<p >You can measure specified code segment with a macro helper <code><a class="el" href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__()</a></code>, it is a wrapper of <code><a class="el" href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea" title="get the elapsed cycles since perf_counter is initialised">get_system_ticks()</a></code>.</p>
<p ><b>Syntax:</b></p>
<div class="fragment"><div class="line"><a class="code hl_define" href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__</a>(&lt;Description String <span class="keywordflow">for</span> the target&gt;, [User Code, see ref 1]) {</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="aperf__counter_8h_html_a147d3eb2e96136dc1758aa8d3e2a089c"><div class="ttname"><a href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__</a></div><div class="ttdeci">#define __cycleof__(__STR,...)</div><div class="ttdef"><b>Definition:</b> <a href="perf__counter_8h_source.html#l00280">perf_counter.h:280</a></div></div>
</div><!-- fragment --><p >Here, [<b>ref 1</b>] is a small user code to read the measurement result via a local variable <code>__cycle_count__</code> for perl lovers, you can also use "`_`" to read the result. This User Code is optional. If you don't put anything here, the measured result will be shown with a <code>printf()</code>.</p>
<h3><a class="anchor" id="autotoc_md4"></a>
&lt;strong&gt;Example 1:&lt;/strong&gt; Simple measurement with printf</h3>
<div class="fragment"><div class="line"><a class="code hl_define" href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__</a>() {</div>
<div class="line">    <span class="keywordflow">foreach</span>(example_lv0_t, s_tItem, ptItem) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Processing item with ID = %d\r\n&quot;</span>, _-&gt;chID);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p >You will see the measured result in console:</p>
<p ><img src="./documents/pictures/__cycleof___output_simple" alt="image-20220509004258020" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md5"></a>
&lt;strong&gt;Example 2:&lt;/strong&gt; Read measured result via &lt;tt&gt;__cycle_counter__&lt;/tt&gt;</h3>
<div class="fragment"><div class="line">int32_t iCycleResult = 0;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* measure cycles and store it in a dedicated variable without printf */</span></div>
<div class="line"><a class="code hl_define" href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__</a>(<span class="stringliteral">&quot;delay_us(1000ul)&quot;</span>, </div>
<div class="line">    <span class="comment">/* insert code to __cycleof__ body, &quot;{}&quot; can be omitted  */</span></div>
<div class="line">    {</div>
<div class="line">        iCycleResult = __cycle_count__;   <span class="comment">/*&lt; &quot;__cycle_count__&quot; stores the result */</span></div>
<div class="line">    }) {</div>
<div class="line">    <a class="code hl_function" href="perf__counter_8c.html#a9776dfed871d0e0775c876f16e7618f7">delay_us</a>(1000ul);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">printf(<span class="stringliteral">&quot;\r\n delay_us(1000ul) takes %d cycles\r\n&quot;</span>, (<span class="keywordtype">int</span>)iCycleResult);</div>
<div class="ttc" id="aperf__counter_8c_html_a9776dfed871d0e0775c876f16e7618f7"><div class="ttname"><a href="perf__counter_8c.html#a9776dfed871d0e0775c876f16e7618f7">delay_us</a></div><div class="ttdeci">void delay_us(int32_t nUs)</div><div class="ttdoc">delay specified time in microsecond</div><div class="ttdef"><b>Definition:</b> <a href="perf__counter_8c_source.html#l00398">perf_counter.c:398</a></div></div>
</div><!-- fragment --><p >The result is read out from <code>__cycle_count__</code>and used in other place:</p>
<p ><img src="./documents/pictures/__cycleof___output_non_printf" alt="image-20220509004714845" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md6"></a>
1.2 Timestamp</h2>
<p >You can get the system timestamp (since the initialization of perf_counter service) via function <code><a class="el" href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea" title="get the elapsed cycles since perf_counter is initialised">get_system_ticks()</a></code> and <code><a class="el" href="perf__counter_8c.html#a98c51d83fdb448a2733d0a309366149c" title="get the elapsed milliseconds since perf_counter is initialised">get_system_ms()</a></code>.</p>
<p ><b>NOTE</b>: The <code><a class="el" href="perf__counter_8c.html#a98c51d83fdb448a2733d0a309366149c" title="get the elapsed milliseconds since perf_counter is initialised">get_system_ms()</a></code> is <b>NOT</b> a wrapper of the function <code><a class="el" href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea" title="get the elapsed cycles since perf_counter is initialised">get_system_ticks()</a></code>.</p>
<p >There are various way to take advantage of those functions.</p>
<h3><a class="anchor" id="autotoc_md7"></a>
Example 3: Use &lt;tt&gt;get_system_ms()&lt;/tt&gt; as random seed</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="perf__counter_8h.html">perf_counter.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) </div>
<div class="line">{</div>
<div class="line">   <span class="keywordtype">int</span> i, n;</div>
<div class="line">   </div>
<div class="line">   n = 5;</div>
<div class="line">   </div>
<div class="line">   <span class="comment">/* Intializes random number generator */</span></div>
<div class="line">   srand((<span class="keywordtype">unsigned</span>) <a class="code hl_function" href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea">get_system_ticks</a>());</div>
<div class="line"> </div>
<div class="line">   <span class="comment">/* Print 5 random numbers from 0 to 1024 */</span></div>
<div class="line">   <span class="keywordflow">for</span>( i = 0 ; i &lt; n ; i++ ) {</div>
<div class="line">      printf(<span class="stringliteral">&quot;%d\n&quot;</span>, rand() &amp; 0x3FF);</div>
<div class="line">   }</div>
<div class="line">   </div>
<div class="line">   <span class="keywordflow">return</span>(0);</div>
<div class="line">}</div>
<div class="ttc" id="aperf__counter_8c_html_a32dabfe5b863f89f71735b20a0caf1ea"><div class="ttname"><a href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea">get_system_ticks</a></div><div class="ttdeci">int64_t get_system_ticks(void)</div><div class="ttdoc">get the elapsed cycles since perf_counter is initialised</div><div class="ttdef"><b>Definition:</b> <a href="perf__counter_8c_source.html#l00472">perf_counter.c:472</a></div></div>
<div class="ttc" id="aperf__counter_8h_html"><div class="ttname"><a href="perf__counter_8h.html">perf_counter.h</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md8"></a>
Example 4: Measure CPU cycles</h3>
<div class="fragment"><div class="line"><span class="keywordflow">do</span> {</div>
<div class="line">    int64_t tStart = <a class="code hl_function" href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea">get_system_ticks</a>();</div>
<div class="line">    <a class="code hl_define" href="perf__counter_8h.html#a966a3eb20671a2a8c44d63d459f5472e">__IRQ_SAFE</a> {</div>
<div class="line">        printf(<span class="stringliteral">&quot;no interrupt \r\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;used clock cycle: %d&quot;</span>, (int32_t)(<a class="code hl_function" href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea">get_system_ticks</a>() - tStart));</div>
<div class="line">} <span class="keywordflow">while</span>(0);</div>
<div class="ttc" id="aperf__counter_8h_html_a966a3eb20671a2a8c44d63d459f5472e"><div class="ttname"><a href="perf__counter_8h.html#a966a3eb20671a2a8c44d63d459f5472e">__IRQ_SAFE</a></div><div class="ttdeci">#define __IRQ_SAFE</div><div class="ttdef"><b>Definition:</b> <a href="perf__counter_8h_source.html#l00264">perf_counter.h:264</a></div></div>
</div><!-- fragment --><p >This example shows how to use the delta value of <code><a class="el" href="perf__counter_8c.html#a32dabfe5b863f89f71735b20a0caf1ea" title="get the elapsed cycles since perf_counter is initialised">get_system_ticks()</a></code> to measure the CPU cycles used by specified code segment. In fact, the <code><a class="el" href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__()</a></code> is implemented in the same way:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define __cycleof__(__STR, ...)                                                 \</span></div>
<div class="line"><span class="preprocessor">            using(int64_t _ = get_system_ticks(), __cycle_count__ = _,          \</span></div>
<div class="line"><span class="preprocessor">                _=_, {                                                          \</span></div>
<div class="line"><span class="preprocessor">                _ = get_system_ticks() - _;                                     \</span></div>
<div class="line"><span class="preprocessor">                __cycle_count__ = _;                                            \</span></div>
<div class="line"><span class="preprocessor">                if (__PLOOC_VA_NUM_ARGS(__VA_ARGS__) == 0) {                    \</span></div>
<div class="line"><span class="preprocessor">                    printf(&quot;\r\n&quot;</span>);                                             \</div>
<div class="line">                    printf(&quot;-[Cycle Report]&quot;);                                  \</div>
<div class="line">                    printf(&quot;--------------------------------------------\r\n&quot;); \</div>
<div class="line">                    printf(__STR &quot; total cycle count: %d [%08x]\r\n&quot;,           \</div>
<div class="line">                            (int)_, (int)_);                                    \</div>
<div class="line">                } else {                                                        \</div>
<div class="line">                    __VA_ARGS__                                                 \</div>
<div class="line">                };                                                              \</div>
<div class="line">            })</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md9"></a>
2. How To Deploy</h1>
<h2><a class="anchor" id="autotoc_md10"></a>
2.1 Generic(Default) method for all compilers</h2>
<h3><a class="anchor" id="autotoc_md11"></a>
2.1.1 For Bare-metal:</h3>
<ol type="1">
<li>Clone the code to your local with following command lines:</li>
</ol>
<div class="fragment"><div class="line">git clone https://github.com/GorgonMeducer/perf_counter.git</div>
</div><!-- fragment --><ol type="1">
<li>Add including path for <code>perf_counter</code> folder</li>
<li>Add <code><a class="el" href="perf__counter_8c.html">perf_counter.c</a></code> to your compilation</li>
<li>Include <a class="el" href="perf__counter_8h.html">perf_counter.h</a> in corresponding c source file:</li>
</ol>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="perf__counter_8h.html">perf_counter.h</a>&quot;</span></div>
</div><!-- fragment --><ol type="1">
<li>Make sure your system contains the CMSIS (with a version 5.7.0 or above) as <code><a class="el" href="perf__counter_8h.html">perf_counter.h</a></code> includes <code>cmsis_compiler.h</code>.</li>
<li>Call the function <code><a class="el" href="perf__counter_8c.html#a0a6e5160f19f152b0b9a502e5e24adb7">user_code_insert_to_systick_handler()</a></code> in your <code>SysTick_Handler()</code></li>
</ol>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SysTick_Handler(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">    <a class="code hl_function" href="perf__counter_8c.html#a0a6e5160f19f152b0b9a502e5e24adb7">user_code_insert_to_systick_handler</a>();</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="aperf__counter_8c_html_a0a6e5160f19f152b0b9a502e5e24adb7"><div class="ttname"><a href="perf__counter_8c.html#a0a6e5160f19f152b0b9a502e5e24adb7">user_code_insert_to_systick_handler</a></div><div class="ttdeci">void user_code_insert_to_systick_handler(void)</div><div class="ttdef"><b>Definition:</b> <a href="perf__counter_8c_source.html#l00233">perf_counter.c:233</a></div></div>
</div><!-- fragment --><p> Implement an empty funciton <code>__ensure_systick_wrapper()</code> as there is no wrapper actually used in this deployment method:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> __ensure_systick_wrapper(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">}</div>
</div><!-- fragment --><ol type="1">
<li>Make sure the <code>SystemCoreClock</code> is updated with the same value as CPU frequency.</li>
<li><b>IMPORTANT</b>: Make sure the <code>SysTick_CTRL_CLKSOURCE_Msk</code> bit ( bit 2) of <code>SysTick-&gt;CTRL</code> register is <code>1</code> that means SysTick runs with the same clock source as the target Cortex-M processor.</li>
<li>Initialize the perf_counter with boolean value that indicates whether the user applications and/or RTOS have already occupied the SysTick.</li>
</ol>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    </div>
<div class="line">    SystemCoreClockUpdate();</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_function" href="perf__counter_8c.html#a9097d62a30ad2b4f75462c78d7200fa8">init_cycle_counter</a>(<span class="keyword">true</span>);</div>
<div class="line">    </div>
<div class="line">    ...</div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        ...</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aperf__counter_8c_html_a9097d62a30ad2b4f75462c78d7200fa8"><div class="ttname"><a href="perf__counter_8c.html#a9097d62a30ad2b4f75462c78d7200fa8">init_cycle_counter</a></div><div class="ttdeci">void init_cycle_counter(bool bIsSysTickOccupied)</div><div class="ttdoc">initialise cycle counter service</div><div class="ttdef"><b>Definition:</b> <a href="perf__counter_8c_source.html#l00280">perf_counter.c:280</a></div></div>
</div><!-- fragment --><ol type="1">
<li><b>IMPORTANT</b>: Please enable GNU extension in your compiler. For <b>GCC</b> and <b>CLANG</b>, it is <code>--std=gnu99</code> or <code>--std=gnu11</code>, and for other compilers, please check the user manual first. Failed to do so, you will not only trigger the warning in <code><a class="el" href="perf__counter_8h.html">perf_counter.h</a></code>, but also lose the function correctness of <code><a class="el" href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__()</a></code> and <code><a class="el" href="perf__counter_8h.html#acfa3bf174dd68eeca5c7e4a16cdc24ea">__super_loop_monitor__()</a></code>, because <code><a class="el" href="perf__counter_8h.html#a9d1c7b8467fca7e2fcf0426ef294a171">__PLOOC_VA_NUM_ARGS()</a></code> isn't report <code>0</code> when passed with no argument.</li>
</ol>
<div class="fragment"><div class="line"><span class="preprocessor">#if __PLOOC_VA_NUM_ARGS() != 0</span></div>
<div class="line"><span class="preprocessor">#warning Please enable GNC extensions, it is required by __cycleof__() and \</span></div>
<div class="line"><span class="preprocessor">__super_loop_monitor__()</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><ol type="1">
<li>It is nice to add macro definition <code>__PERF_COUNTER__</code> to your project GLOBALLY. It helps other module to detect the existence of perf_counter. For Example, LVGL <a href="https://github.com/lvgl/lvgl/blob/d367bb7cf17dc34863f4439bba9b66a820088951/env_support/cmsis-pack/lv_conf_cmsis.h#L81-L99"><code>lv_conf_cmsis.h</code></a> use this macro to detect perf_counter and uses <code><a class="el" href="perf__counter_8c.html#a98c51d83fdb448a2733d0a309366149c" title="get the elapsed milliseconds since perf_counter is initialised">get_system_ms()</a></code> to implement <code>lv_tick_get()</code>.</li>
</ol>
<p ><b>Enjoy !</b></p>
<h2><a class="anchor" id="autotoc_md12"></a>
2.2 Use cmsis-pack in MDK</h2>
<ol type="1">
<li>Download the cmsis-pack from <code>cmsis-pack</code> folder. It is a file with name <code>GorgonMeducer.perf_counter.&lt;version&gt;.pack</code>, for example <code>GorgonMeducer.perf_counter.1.9.4.pack</code></li>
<li><p class="startli">Double click it to install this cmsis-pack. Once finished, you can find it in your Pack-Installer:</p>
<p class="startli"><img src="./documents/pictures/pack_installer" alt="" class="inline"/> In the future, you can pull the latest version of perf_counter from the menu <code>Packs-&gt;Check For Updates</code> as shown below:</p>
<p class="startli"><img src="./documents/pictures/check_for_updates" alt="image-20220509011327392" class="inline"/></p>
</li>
<li>Open the RTE management window, find the <b>Utilities</b> and select the <b>Core</b> inside perf_counter as shown below:</li>
</ol>
<p ><img src="./documents/pictures\RTE" alt="" class="inline"/></p>
<ol type="1">
<li>Include <code><a class="el" href="perf__counter_8h.html">perf_counter.h</a></code> in corresponding c source file:</li>
</ol>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="perf__counter_8h.html">perf_counter.h</a>&quot;</span></div>
</div><!-- fragment --><ol type="1">
<li>Make sure your system contains the CMSIS (with a version 5.7.0 or above) as <code><a class="el" href="perf__counter_8h.html">perf_counter.h</a></code> includes <code>cmsis_compiler.h</code>. Usually, you should do this with RTE as shown below:</li>
</ol>
<p ><img src="./documents/pictures/RTE_cmsis_core" alt="image-20220509012432408" class="inline"/></p>
<ol type="1">
<li>Make sure the <code>SystemCoreClock</code> is updated with the same value as CPU frequency.</li>
<li><b>IMPORTANT</b>: Make sure the <code>SysTick_CTRL_CLKSOURCE_Msk</code> bit ( bit 2) of <code>SysTick-&gt;CTRL</code> register is <code>1</code> that means SysTick runs with the same clock source as the target Cortex-M processor.</li>
<li>Initialize the perf_counter with boolean value that indicates whether the user applications and/or RTOS have already occupied the SysTick.</li>
</ol>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    </div>
<div class="line">    SystemCoreClockUpdate();</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_function" href="perf__counter_8c.html#a9097d62a30ad2b4f75462c78d7200fa8">init_cycle_counter</a>(<span class="keyword">true</span>);</div>
<div class="line">    </div>
<div class="line">    ...</div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        ...</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><ol type="1">
<li><p class="startli"><b>IMPORTANT</b>: Please enable GNU extension in your compiler.</p>
<p class="startli">For Arm Compiler 5, please select both <b>C99 mode</b> and GNU extensions in the <b>Option for target dialog</b> as shown below:</p>
</li>
</ol>
<p ><img src="./documents/pictures/GNU_in_AC5" alt="image-20220509012752097" class="inline"/></p>
<p >For Arm Compiler 6, please select <b>gnu99</b> or <b>gnu11</b> in Language C drop-list as shown below:</p>
<p ><img src="./documents/pictures/gnu_in_ac6" alt="image-20220509012944724" class="inline"/></p>
<p >Failed to do so, you will not only trigger the warning in <code><a class="el" href="perf__counter_8h.html">perf_counter.h</a></code>, but also lose the function correctness of <code><a class="el" href="perf__counter_8h.html#a147d3eb2e96136dc1758aa8d3e2a089c">__cycleof__()</a></code> and <code><a class="el" href="perf__counter_8h.html#acfa3bf174dd68eeca5c7e4a16cdc24ea">__super_loop_monitor__()</a></code>, because <code><a class="el" href="perf__counter_8h.html#a9d1c7b8467fca7e2fcf0426ef294a171">__PLOOC_VA_NUM_ARGS()</a></code> isn't report <code>0</code> when passed with no argument.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if __PLOOC_VA_NUM_ARGS() != 0</span></div>
<div class="line"><span class="preprocessor">#warning Please enable GNC extensions, it is required by __cycleof__() and \</span></div>
<div class="line"><span class="preprocessor">__super_loop_monitor__()</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p ><b>Enjoy !</b></p>
<h1><a class="anchor" id="autotoc_md13"></a>
3. FAQ</h1>
<h2><a class="anchor" id="autotoc_md14"></a>
3.1 Why I see &lt;tt&gt;Undefined symbol $Super$$SysTick_Handler&lt;/tt&gt;</h2>
<p >This error usually pops-up in <b>Arm Compiler 5</b> and <b>Arm Compiler 6</b>, it is because you haven't implement any non-weak <code>Systick_Handler()</code>. Please provide an EMPTY one in any c source file to solve this problem:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SysTick_Handler(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">}</div>
</div><!-- fragment --><p ><b>NOTE</b>: If you deploy perf_counter using cmsis-pack and encounter this issue, please <b>DO NOT</b> call function <code><a class="el" href="perf__counter_8c.html#a0a6e5160f19f152b0b9a502e5e24adb7">user_code_insert_to_systick_handler()</a></code> in this <b>should-be-empty</b> <code>SysTick_Handler()</code>.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
4.  License</h1>
<p ><b>Performance Counter for Cortex-M</b>, a.k.a. <em><b>perf_counter</b></em> is under Apache 2.0 license. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
